<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>뉴스레터 구독</title>
  <style>
    body{font-family:system-ui,-apple-system,'Apple SD Gothic Neo',Malgun Gothic,sans-serif;padding:24px}
    .card{max-width:480px;margin:0 auto;padding:20px;border:1px solid #eee;border-radius:12px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    input,button{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:16px}
    button{background:#0b5fff;color:#fff;border:none;cursor:pointer;margin-top:14px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:12px;font-size:14px}
    .msg.error{color:#b00020}
    .msg.ok{color:#0b7f2a}
    .hp{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <div class="card">
    <h2>뉴스레터 구독</h2>
    <form id="subForm" novalidate>
      <!-- 봇 차단용 허니팟 -->
      <div class="hp">
        <label>Leave this empty</label>
        <input type="text" name="website" autocomplete="off"/>
      </div>

      <label for="email">이메일 *</label>
      <input id="email" name="email" type="email" required placeholder="you@example.com"/>

      <label for="name">이름 (선택)</label>
      <input id="name" name="name" type="text" placeholder="홍길동"/>

      <!-- 시트의 Tags 컬럼과 매핑 -->
      <label for="tags">태그(쉼표로 구분, 선택)</label>
      <input id="tags" name="tags" type="text" placeholder="dev, ai"/>

      <!-- Status 입력 UI 제거: 서버(validate_input)에서 강제 설정 -->

      <button id="submitBtn" type="submit">구독하기</button>
      <div id="msg" class="msg"></div>
    </form>
  </div>

  <script>
    // Activepieces Webhook URL (Catch Webhook에서 "Copy URL"로 복사한 값)
    const WEBHOOK_URL = "https://cloud.activepieces.com/api/v1/webhooks/jKFCs3RRDQWSQfpI1ynyF";

    const isEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||"").trim());

    const form = document.getElementById('subForm');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.className = 'msg';
      msg.textContent = '';

      const data = {
        email: form.email.value.trim().toLowerCase(),
        name:  form.name.value.trim(),
        tags:  form.tags.value.trim(),
        website: form.website ? form.website.value.trim() : "" // honeypot
        // status는 폼에서 보내지 않음 (서버에서 강제)
      };

      // 1차(클라이언트) 검증
      if (data.website) { msg.className='msg error'; msg.textContent='봇 의심 요청입니다.'; return; }
      if (!isEmail(data.email)) { msg.className='msg error'; msg.textContent='이메일 형식을 확인해 주세요.'; return; }

      btn.disabled = true;
      btn.textContent = '전송 중...';

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        // 응답이 JSON이 아닐 수도 있어 대비
        let payload;
        const text = await res.text();
        try { payload = text ? JSON.parse(text) : {}; } catch { payload = { message: text }; }

        msg.className = res.ok ? 'msg ok' : 'msg error';
        msg.textContent = payload.message || (res.ok ? '구독 신청 완료' : `오류: ${res.status}`);

        if (res.ok) form.reset();
      } catch (err) {
        console.error(err);
        msg.className = 'msg error';
        msg.textContent = '네트워크 오류. 잠시 후 다시 시도해 주세요.';
      } finally {
        btn.disabled = false;
        btn.textContent = '구독하기';
      }
    });
  </script>
</body>
</html>
